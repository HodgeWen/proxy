{
  "$schema": "https://json-schema.org/draft-07/schema#",
  "$id": "https://raw.githubusercontent.com/HodgeWen/rulesets/main/rule-set.schema.json",
  "title": "sing-box rule_set (Source Format)",
  "description": "用于 sing-box 1.12+ 的 rule_set Source Format 基本字段提示。",
  "type": "object",
  "required": ["version", "rules"],
  "additionalProperties": false,
  "properties": {
    "$schema": {
      "type": "string",
      "description": "可选，指向本 schema 的路径或 URL，用于编辑器提示。"
    },
    "version": {
      "type": "integer",
      "enum": [3, 4],
      "description": "规则集版本（1.12 建议 3，1.13 可用 4）。"
    },
    "rules": {
      "type": "array",
      "minItems": 1,
      "items": { "$ref": "#/definitions/headlessRule" }
    }
  },
  "definitions": {
    "stringArray": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1
    },
    "cidrString": {
      "type": "string",
      "description": "IPv4/IPv6 CIDR，例如 203.0.113.1/32 或 2001:db8::/32。",
      "pattern": "^(?:\\d{1,3}\\.){3}\\d{1,3}/\\d{1,2}|[0-9a-fA-F:]+/\\d{1,3}$"
    },
    "singlePort": {
      "description": "单端口（0-65535）",
      "oneOf": [
        { "type": "integer", "minimum": 0, "maximum": 65535 },
        { "type": "string", "pattern": "^\\d{1,5}$" }
      ]
    },
    "portRange": {
      "type": "string",
      "description": "端口区间，如 1000:2000、:443、80:。",
      "pattern": "^(?:\\d{1,5}:\\d{1,5}|\\d{1,5}:|:\\d{1,5})$"
    },
    "headlessRule": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "type": { "type": "string", "enum": ["logical"] },
        "mode": { "type": "string", "enum": ["and", "or"] },
        "rules": {
          "type": "array",
          "minItems": 1,
          "items": { "$ref": "#/definitions/headlessRule" }
        },
        "domain": { "$ref": "#/definitions/stringArray" },
        "domain_suffix": { "$ref": "#/definitions/stringArray" },
        "domain_keyword": { "$ref": "#/definitions/stringArray" },
        "domain_regex": { "$ref": "#/definitions/stringArray" },
        "geosite": { "$ref": "#/definitions/stringArray" },
        "source_geosite": { "$ref": "#/definitions/stringArray" },
        "geoip": { "$ref": "#/definitions/stringArray" },
        "source_geoip": { "$ref": "#/definitions/stringArray" },
        "asn": {
          "type": "array",
          "items": { "type": "integer", "minimum": 0 },
          "minItems": 1
        },
        "ip_cidr": {
          "type": "array",
          "items": { "$ref": "#/definitions/cidrString" },
          "minItems": 1
        },
        "source_ip_cidr": {
          "type": "array",
          "items": { "$ref": "#/definitions/cidrString" },
          "minItems": 1
        },
        "ip_is_private": { "type": "boolean" },
        "source_ip_is_private": { "type": "boolean" },
        "port": {
          "oneOf": [
            { "$ref": "#/definitions/singlePort" },
            {
              "type": "array",
              "items": { "$ref": "#/definitions/singlePort" },
              "minItems": 1
            }
          ]
        },
        "port_range": {
          "oneOf": [
            { "$ref": "#/definitions/portRange" },
            {
              "type": "array",
              "items": { "$ref": "#/definitions/portRange" },
              "minItems": 1
            }
          ]
        },
        "source_port": {
          "oneOf": [
            { "$ref": "#/definitions/singlePort" },
            {
              "type": "array",
              "items": { "$ref": "#/definitions/singlePort" },
              "minItems": 1
            }
          ]
        },
        "source_port_range": {
          "oneOf": [
            { "$ref": "#/definitions/portRange" },
            {
              "type": "array",
              "items": { "$ref": "#/definitions/portRange" },
              "minItems": 1
            }
          ]
        },
        "network": {
          "type": "array",
          "items": { "type": "string", "enum": ["tcp", "udp", "icmp"] },
          "minItems": 1
        },
        "inbound": { "$ref": "#/definitions/stringArray" },
        "protocol": { "$ref": "#/definitions/stringArray" },
        "ip_version": {
          "oneOf": [
            { "type": "integer", "enum": [4, 6] },
            {
              "type": "array",
              "items": { "type": "integer", "enum": [4, 6] },
              "minItems": 1
            }
          ]
        },
        "process_name": { "$ref": "#/definitions/stringArray" },
        "process_path": { "$ref": "#/definitions/stringArray" },
        "process_path_regex": { "$ref": "#/definitions/stringArray" },
        "package_name": { "$ref": "#/definitions/stringArray" },
        "user": { "$ref": "#/definitions/stringArray" },
        "clash_mode": { "$ref": "#/definitions/stringArray" },
        "invert": { "type": "boolean" }
      },
      "allOf": [
        {
          "if": {
            "properties": { "type": { "const": "logical" } },
            "required": ["type"]
          },
          "then": { "required": ["mode", "rules"] }
        }
      ]
    }
  }
}
